{"title":"使用zuul网关，hystrix不生效的问题，方法调用超时","date":"2018-09-12T10:58:17.000Z","slug":"使用zuul网关，hystrix不生效的问题，方法调用超时","tags":["SpringCloud"],"categories":["JAVA"],"updated":"2018-09-12T11:00:57.559Z","content":"<h2 id=\"背景\"><a href=\"#背景\" class=\"headerlink\" title=\"背景\"></a>背景</h2><blockquote>\n<p>在使用zuul结合<code>ribbon</code>或<code>feign</code>时实现服务转发，负载均衡，出现服务调用失败，页面总是出现500.熔断器失败的问题。</p>\n</blockquote>\n<h4 id=\"需要再zuul的配置文件中添加如下信息：\"><a href=\"#需要再zuul的配置文件中添加如下信息：\" class=\"headerlink\" title=\"需要再zuul的配置文件中添加如下信息：\"></a>需要再zuul的配置文件中添加如下信息：</h4><blockquote>\n<p>设置熔断器的超时时间</p>\n</blockquote>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">zuul:</span><br><span class=\"line\">  host:</span><br><span class=\"line\">    connect-timeout-millis: <span class=\"number\">60000</span></span><br><span class=\"line\">#    socket超时时间，如果使用service-id方式是不用配置的</span><br><span class=\"line\">#    socket-timeout-millis: 3000</span><br><span class=\"line\"></span><br><span class=\"line\">hystrix:</span><br><span class=\"line\">  command:</span><br><span class=\"line\">    <span class=\"keyword\">default</span>:</span><br><span class=\"line\">      execution:</span><br><span class=\"line\">        isolation:</span><br><span class=\"line\">          thread:</span><br><span class=\"line\">            timeoutInMilliseconds: <span class=\"number\">6000</span></span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>feign默认关闭hystrix断路器功能</p>\n</blockquote>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">feign:</span><br><span class=\"line\">  hystrix:</span><br><span class=\"line\">    enabled: <span class=\"keyword\">true</span></span><br></pre></td></tr></table></figure>\n<h4 id=\"如果熔断器经常被调用，说明远程调用的超时时间存在问题，我们需要重新设置超时时间。\"><a href=\"#如果熔断器经常被调用，说明远程调用的超时时间存在问题，我们需要重新设置超时时间。\" class=\"headerlink\" title=\"如果熔断器经常被调用，说明远程调用的超时时间存在问题，我们需要重新设置超时时间。\"></a>如果熔断器经常被调用，说明远程调用的超时时间存在问题，我们需要重新设置超时时间。</h4><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ribbon:</span><br><span class=\"line\">#方法调用处理时间</span><br><span class=\"line\">  ReadTimeout: <span class=\"number\">6000</span></span><br><span class=\"line\">#连接时间</span><br><span class=\"line\">  ConnectTimeout: <span class=\"number\">60000</span></span><br><span class=\"line\">##最大自动重试次数</span><br><span class=\"line\">  maxAutoRetries: <span class=\"number\">1</span></span><br><span class=\"line\">## 换实例重试次数</span><br><span class=\"line\">  MaxAutoRetriesNextServer: <span class=\"number\">2</span></span><br></pre></td></tr></table></figure>\n<h4 id=\"1-TIMEOUT\"><a href=\"#1-TIMEOUT\" class=\"headerlink\" title=\"1/TIMEOUT\"></a>1/TIMEOUT</h4><blockquote>\n<p>Zuul的请求通过Hystrix来进行监视，其目的是，针对长时间运行的请求做超时处理。</p>\n</blockquote>\n<blockquote>\n<p>Hystrix提供了两种不同的执行命令来强制执行超时：<code>SEMAPHORE</code>和<code>THREAD</code>执行超时。</p>\n</blockquote>\n<ul>\n<li><code>THREAD</code>模式</li>\n</ul>\n<blockquote>\n<p>当使用thread进行隔离的时候，Hystrix命令会通过从线程池分离一个单独的线程来执行。<br>Hystrix会暂停这个持有请求的线程，直到下游服务器收到响应，或者发生超时。</p>\n</blockquote>\n<blockquote>\n<ul>\n<li><code>上游就是，需要调用你的服务的接口的服务器</code></li>\n<li><code>下游就是，你需要去调接口的服务器</code></li>\n</ul>\n</blockquote>\n<ul>\n<li><code>SEMAPHORE</code></li>\n</ul>\n<blockquote>\n<p>使用SEMAPHORE隔离时，会在请求线程上执行Hystrix命令.仅在从下游服务器收到响应后才检测超时.因此，如果您将Zuul / Hystrix配置为超时5秒，并且您的服务需要30秒才能完成.只有在30秒后，您的客户才会收到超时通知 - 即使服务响应成功。</p>\n</blockquote>\n<p>除少数情况外，Netflix建议默认执行<code>THREAD</code>,SpringCloud Zuul默认集成<code>SEMAPHORE</code>模式。</p>\n<hr>\n<h4 id=\"2-RETRY\"><a href=\"#2-RETRY\" class=\"headerlink\" title=\"2/ RETRY\"></a>2/ RETRY</h4><blockquote>\n<p>Ribbon 使用远程服务调用，它使用Eureka提供的信息来确定可用的服务和相应的地址。Eureka使用一个本地缓存，每30秒更新一次的本地缓存。你调用的本地服务，可能是过时的服务，或者是服务已经不存在。</p>\n</blockquote>\n<blockquote>\n<p>Ribbon 当无法连接到服务的时候，或进行自动重试机制。通过配置，可以设置在尝试连接另一台服务器之前，重试相同的服务器几次。</p>\n</blockquote>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 最大的重试相同服务器次数 (不包含第一次重试)</span><br><span class=\"line\">ribbon.maxAutoRetries = <span class=\"number\">1</span></span><br><span class=\"line\"></span><br><span class=\"line\"># 最大的尝试下一台服务器次数 (不包含第一个服务)</span><br><span class=\"line\">ribbon.MaxAutoRetriesNextServer = <span class=\"number\">2</span></span><br></pre></td></tr></table></figure>\n<hr>\n<h4 id=\"3-CONNECT-TIMEOUT\"><a href=\"#3-CONNECT-TIMEOUT\" class=\"headerlink\" title=\"3/ CONNECT TIMEOUT\"></a>3/ CONNECT TIMEOUT</h4><blockquote>\n<p>连接远程服务器失败的时间非常短，停止服务的时间非常长。尝试连接没有服务监听的TCP端口应该立即失败，</p>\n</blockquote>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># Connect timeout used by Apache HttpClient</span><br><span class=\"line\">ribbon.ConnectTimeout=<span class=\"number\">3000</span></span><br><span class=\"line\"></span><br><span class=\"line\"># Read timeout used by Apache HttpClient</span><br><span class=\"line\">ribbon.ReadTimeout=<span class=\"number\">5000</span></span><br></pre></td></tr></table></figure>\n","prev":{"title":"hystrix的基本使用","slug":"hystrix的基本使用"},"next":{"title":"使用IDEA查看Class文件字节码","slug":"使用IDEA查看Class文件字节码"},"link":"https://easyhaloo.github.io/post/使用zuul网关，hystrix不生效的问题，方法调用超时/","toc":[{"title":"背景","id":"背景","index":"1"}],"copyright":true}